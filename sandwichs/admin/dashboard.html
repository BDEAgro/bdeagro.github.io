<!DOCTYPE html>
<html lang="fr" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard administrateur - Club Agro BDE">
    <title>Dashboard Admin - Club Agro | BDE Agro - UCLouvain</title>
    <link rel="shortcut icon" href="../assets/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../apple-touch-icon.png" sizes="180x180">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        :root {
            --agro-green: #A8C302;
            --agro-dark-green: #2e7d32;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid var(--agro-green);
        }

        .table-container {
            overflow-x: auto;
        }

        .table th {
            background-color: var(--agro-green);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table td {
            border-color: #e9ecef;
            vertical-align: middle;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 195, 2, 0.4);
            color: white;
        }

        .btn-danger-admin {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-danger-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            color: white;
        }

        .stats-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--agro-dark-green);
        }

        .stats-label {
            color: #6c757d;
            font-weight: 500;
        }

        .last-update {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .cors-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">Dashboard Administrateur</h1>
                    <p class="mb-0">Commandes du jour - Club Agro</p>
                </div>
                <div>
                    <button class="btn btn-admin me-2" id="refreshBtn">
                        üîÑ Actualiser
                    </button>
                    <button class="btn btn-danger-admin" id="logoutBtn">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Alerte CORS -->
        <div class="cors-warning d-none" id="corsWarning">
            <h5>‚ö†Ô∏è Probl√®me de connexion d√©tect√©</h5>
            <p class="mb-2">Si les donn√©es ne se chargent pas, voici les solutions disponibles :</p>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-success btn-sm" id="tryGetBtn">üì° Essayer GET</button>
                <button class="btn btn-warning btn-sm" id="tryJsonpBtn">üîÑ Essayer JSONP</button>
            </div>
            <small class="text-muted d-block mt-2">
                GET fonctionne mieux avec Google Apps Script. JSONP est le plan B.
            </small>
        </div>

        <!-- Statistiques rapides -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalCommandes">-</div>
                    <div class="stats-label">Commandes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalSandwichs">-</div>
                    <div class="stats-label">Sandwichs</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="sandwichPopulaire">-</div>
                    <div class="stats-label">Plus populaire</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="derniereActualisation">-</div>
                    <div class="stats-label">Derni√®re MAJ</div>
                </div>
            </div>
        </div>

        <!-- Tableau des commandes par pr√©nom -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0" style="color: var(--agro-dark-green);">Commandes par client</h3>
                <span class="last-update">
                    Actualisation automatique toutes les 30 secondes
                </span>
            </div>

            <div class="table-container">
                <table class="table table-hover" id="tableauCommandes">
                    <thead>
                        <tr>
                            <th>Pr√©nom</th>
                            <th>Sandwichs command√©s</th>
                            <th>Commentaires</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="empty-state">
                                Chargement des commandes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- R√©sum√© par type de sandwich -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">R√©sum√© de production</h3>
            
            <div class="table-container">
                <table class="table table-hover" id="resumeCommandes">
                    <thead>
                        <tr>
                            <th>Type de sandwich</th>
                            <th>Quantit√© totale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2" class="empty-state">
                                Chargement du r√©sum√©...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instructions pour les pr√©parateurs -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">Instructions de pr√©paration</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Berger Apicole (3,50‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Ch√®vre ‚Ä¢ Miel ‚Ä¢ Roquette ‚Ä¢ Noix ‚Ä¢ Pomme</p>
                </div>
                <div class="col-md-6">
                    <h5>Club (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Jambon ‚Ä¢ Mayo ‚Ä¢ Salade</p>
                </div>
                <div class="col-md-6">
                    <h5>Meat Free (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> L√©gumes grill√©s ‚Ä¢ Houmous ‚Ä¢ Avocat</p>
                </div>
                <div class="col-md-6">
                    <h5>Italien (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Jambon de Parme ‚Ä¢ Pesto ‚Ä¢ Roquette ‚Ä¢ Mozza ‚Ä¢ Tomate s√©ch√©e</p>
                </div>
                <div class="col-md-6">
                    <h5>Norv√©gien (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Saumon ‚Ä¢ Philadelphia ‚Ä¢ Salade</p>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <strong>Important:</strong> Les prix affich√©s sont pour les √©tudiants. Tarif non-√©tudiant : 4‚Ç¨ pour tous les sandwichs.
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
    </script>
    
    <script>
        // Configuration API
        const API_URL = "https://script.google.com/macros/s/AKfycbwSDp_vaj1ZjATBibQHi-50OL380L_Rcz7sEFhyzbiuLUygq_TJm-zADHhvpoPFtPWRuQ/exec";

        // Variables globales
        let currentToken = null;
        let autoRefreshInterval = null;
        let useJsonp = false;

        // Fonction JSONP pour contourner CORS
        function makeJsonpRequest(url, params) {
            return new Promise((resolve, reject) => {
                // Cr√©er un nom de callback unique
                const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                
                // Cr√©er l'URL avec les param√®tres
                const queryParams = new URLSearchParams({
                    ...params,
                    callback: callbackName
                });
                const fullUrl = `${url}?${queryParams.toString()}`;
                
                // Cr√©er la fonction callback globale
                window[callbackName] = function(data) {
                    // Nettoyer
                    document.head.removeChild(script);
                    delete window[callbackName];
                    resolve(data);
                };
                
                // Cr√©er et ins√©rer le script
                const script = document.createElement('script');
                script.src = fullUrl;
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('JSONP request failed'));
                };
                
                document.head.appendChild(script);
                
                // Timeout apr√®s 10 secondes
                setTimeout(() => {
                    if (window[callbackName]) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('JSONP request timeout'));
                    }
                }, 10000);
            });
        }

        // Fonction GET standard avec param√®tres URL
        async function makeGetRequest(params) {
            const queryParams = new URLSearchParams(params);
            const fullUrl = `${API_URL}?${queryParams.toString()}`;
            
            const response = await fetch(fullUrl, {
                method: 'GET',
                mode: 'cors',
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // Fonction pour faire une requ√™te (GET, POST ou JSONP selon les besoins)
        async function makeRequest(params) {
            if (useJsonp) {
                return await makeJsonpRequest(API_URL, params);
            } else {
                try {
                    // Essayer d'abord avec GET (plus compatible avec Google Apps Script)
                    return await makeGetRequest(params);
                } catch (error) {
                    console.log('GET failed, trying POST:', error.message);
                    
                    // Si GET √©choue, essayer POST
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(params)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                }
            }
        }

        // Fonction pour r√©cup√©rer les commandes du jour
        async function getCommandes() {
            try {
                const result = await makeRequest({
                    action: 'getCommandes',
                    token: currentToken
                });
                
                if (result.success) {
                    return result.data;
                } else {
                    throw new Error(result.message || 'Erreur lors de la r√©cup√©ration des commandes');
                }
            } catch (error) {
                console.error('Erreur r√©cup√©ration commandes:', error);
                
                // Si c'est une erreur CORS et qu'on n'utilise pas encore JSONP
                if (!useJsonp && (error.message.includes('CORS') || error.message.includes('Failed to fetch'))) {
                    document.getElementById('corsWarning').classList.remove('d-none');
                    afficherNotification('Probl√®me CORS d√©tect√©. Cliquez sur "Essayer avec JSONP" ci-dessus.', 'warning');
                } else {
                    afficherNotification('Erreur lors de la r√©cup√©ration des commandes: ' + error.message, 'error');
                }
                
                return {};
            }
        }

        // Fonction pour remplir les tableaux avec les donn√©es
        function remplirTableaux(data) {
            remplirTableauCommandes(data);
            remplirTableauResume(data);
            mettreAJourStatistiques(data);
            mettreAJourDerniereActualisation();
        }

        // Fonction pour remplir le tableau des commandes par pr√©nom
        function remplirTableauCommandes(data) {
            const tbody = document.querySelector('#tableauCommandes tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            for (let prenom in data) {
                const tr = document.createElement('tr');

                // Colonne pr√©nom
                const tdPrenom = document.createElement('td');
                tdPrenom.textContent = prenom;
                tdPrenom.style.fontWeight = 'bold';
                tr.appendChild(tdPrenom);

                // Colonne sandwichs
                const tdSandwichs = document.createElement('td');
                const sandwichs = data[prenom].sandwichs || {};
                const sandwichsText = Object.entries(sandwichs)
                    .filter(([type, nb]) => nb > 0)
                    .map(([type, nb]) => `${type} (${nb})`)
                    .join(", ");
                tdSandwichs.textContent = sandwichsText || 'Aucun sandwich';
                tr.appendChild(tdSandwichs);

                // Colonne commentaires
                const tdCommentaire = document.createElement('td');
                const commentaires = (data[prenom].commentaire || [])
                    .filter(comm => comm.trim() !== "")
                    .join(" | ");
                tdCommentaire.textContent = commentaires || '-';
                tr.appendChild(tdCommentaire);

                tbody.appendChild(tr);
            }

            // Afficher un message si aucune commande
            if (Object.keys(data).length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'Aucune commande pour aujourd\'hui';
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                tr.appendChild(td);
                tbody.appendChild(tr);
            }
        }

        // Fonction pour remplir le tableau de r√©sum√©
        function remplirTableauResume(data) {
            const resumeBody = document.querySelector('#resumeCommandes tbody');
            if (!resumeBody) return;
            
            resumeBody.innerHTML = '';
            const totaux = {};

            // Calculer les totaux par type de sandwich
            for (let prenom in data) {
                const sandwichs = data[prenom].sandwichs || {};
                for (let type in sandwichs) {
                    const nb = Number(sandwichs[type]) || 0;
                    totaux[type] = (totaux[type] || 0) + nb;
                }
            }

            // Types de sandwichs avec noms d'affichage
            const typesSandwichs = {
                'berger': 'Berger Apicole',
                'club': 'Club',
                'meat_free': 'Meat Free',
                'italien': 'Italien',
                'norvegien': 'Norv√©gien'
            };

            // Afficher tous les types m√™me si quantit√© = 0
            Object.entries(typesSandwichs).forEach(([type, nom]) => {
                const tr = document.createElement('tr');
                
                const tdType = document.createElement('td');
                tdType.textContent = nom;
                tr.appendChild(tdType);

                const tdTotal = document.createElement('td');
                const total = totaux[type] || 0;
                tdTotal.textContent = total;
                tdTotal.style.fontWeight = 'bold';
                
                // Colorer en vert si > 0
                if (total > 0) {
                    tdTotal.style.color = '#28a745';
                }
                
                tr.appendChild(tdTotal);
                resumeBody.appendChild(tr);
            });
        }

        // Fonction pour mettre √† jour l'heure de derni√®re actualisation
        function mettreAJourDerniereActualisation() {
            const spanActualisation = document.getElementById('derniereActualisation');
            if (spanActualisation) {
                const maintenant = new Date();
                spanActualisation.textContent = maintenant.toLocaleTimeString('fr-FR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        // Fonction pour mettre √† jour les statistiques
        function mettreAJourStatistiques(data) {
            const totalCommandes = Object.keys(data).length;
            let totalSandwichs = 0;
            const totauxParType = {};

            // Calculer les totaux
            for (let prenom in data) {
                const sandwichs = data[prenom].sandwichs || {};
                for (let type in sandwichs) {
                    const nb = Number(sandwichs[type]) || 0;
                    totalSandwichs += nb;
                    totauxParType[type] = (totauxParType[type] || 0) + nb;
                }
            }

            // Trouver le sandwich le plus populaire
            let sandwichPopulaire = '-';
            let maxQuantite = 0;
            const nomsAffichage = {
                'berger': 'Berger',
                'club': 'Club',
                'meat_free': 'Meat Free',
                'italien': 'Italien',
                'norvegien': 'Norv√©gien'
            };

            for (let type in totauxParType) {
                if (totauxParType[type] > maxQuantite) {
                    maxQuantite = totauxParType[type];
                    sandwichPopulaire = nomsAffichage[type] || type;
                }
            }

            // Mettre √† jour l'affichage
            document.getElementById('totalCommandes').textContent = totalCommandes;
            document.getElementById('totalSandwichs').textContent = totalSandwichs;
            document.getElementById('sandwichPopulaire').textContent = sandwichPopulaire;
        }

        // Fonction pour actualiser les donn√©es
        async function actualiserDonnees() {
            const data = await getCommandes();
            remplirTableaux(data);
        }

        // Fonction de d√©connexion
        async function deconnexion() {
            try {
                // Invalider le token c√¥t√© serveur
                await makeRequest({
                    action: 'invaliderToken',
                    token: currentToken
                });
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
            }

            // Nettoyer c√¥t√© client
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminTokenTime');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Rediriger vers la page de connexion
            window.location.href = 'login.html';
        }

        // Fonction pour afficher les notifications
        function afficherNotification(message, type) {
            const notification = document.getElementById('notification');
            if (notification) {
                const alertClass = type === 'success' ? 'success' : 
                                 type === 'warning' ? 'warning' : 'danger';
                
                notification.innerHTML = `
                    <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Auto-masquer apr√®s 5 secondes
                setTimeout(() => {
                    const alert = notification.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 5000);
            }
        }

        // Fonction pour essayer JSONP
        function essayerJsonp() {
            useJsonp = true;
            document.getElementById('corsWarning').classList.add('d-none');
            afficherNotification('Passage en mode JSONP. Actualisation des donn√©es...', 'success');
            actualiserDonnees();
        }

        // Fonction pour essayer les requ√™tes GET standard
        function essayerGet() {
            useJsonp = false;
            document.getElementById('corsWarning').classList.add('d-none');
            afficherNotification('Essai avec requ√™tes GET standard...', 'success');
            actualiserDonnees();
        }

        // Initialisation quand le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier l'authentification
            currentToken = sessionStorage.getItem('adminToken');
            
            if (!currentToken) {
                window.location.href = 'login.html';
                return;
            }

            // V√©rifier si le token est encore valide
            try {
                const result = await makeRequest({
                    action: 'verifierToken',
                    token: currentToken
                });
                
                if (!result.success || !result.valide) {
                    sessionStorage.removeItem('adminToken');
                    sessionStorage.removeItem('adminTokenTime');
                    window.location.href = 'login.html';
                    return;
                }
            } catch (error) {
                console.error('Erreur v√©rification token:', error);
                
                // Si erreur CORS, proposer JSONP
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    document.getElementById('corsWarning').classList.remove('d-none');
                } else {
                    window.location.href = 'login.html';
                    return;
                }
            }

            // Charger les donn√©es initiales
            await actualiserDonnees();

            // Configurer les gestionnaires d'√©v√©nements
            const btnDeconnexion = document.getElementById('logoutBtn');
            if (btnDeconnexion) {
                btnDeconnexion.addEventListener('click', deconnexion);
            }

            const btnActualiser = document.getElementById('refreshBtn');
            if (btnActualiser) {
                btnActualiser.addEventListener('click', actualiserDonnees);
            }

            const btnJsonp = document.getElementById('tryJsonpBtn');
            if (btnJsonp) {
                btnJsonp.addEventListener('click', essayerJsonp);
            }

            const btnGet = document.getElementById('tryGetBtn');
            if (btnGet) {
                btnGet.addEventListener('click', essayerGet);
            }

            // Actualisation automatique toutes les 30 secondes
            autoRefreshInterval = setInterval(actualiserDonnees, 30000);
        });
    </script>
</body>

</html>