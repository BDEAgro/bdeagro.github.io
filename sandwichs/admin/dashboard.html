<!DOCTYPE html>
<html lang="fr" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard administrateur - Club Agro BDE">
    <title>Dashboard Admin - Club Agro | BDE Agro - UCLouvain</title>
    <link rel="shortcut icon" href="../assets/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../apple-touch-icon.png" sizes="180x180">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        :root {
            --agro-green: #A8C302;
            --agro-dark-green: #2e7d32;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid var(--agro-green);
        }

        .table-container {
            overflow-x: auto;
        }

        .table th {
            background-color: var(--agro-green);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table td {
            border-color: #e9ecef;
            vertical-align: middle;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 195, 2, 0.4);
            color: white;
        }

        .btn-danger-admin {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-danger-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            color: white;
        }

        .stats-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--agro-dark-green);
        }

        .stats-label {
            color: #6c757d;
            font-weight: 500;
        }

        .last-update {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .status-indicator {
            padding: 0.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">Dashboard Administrateur</h1>
                    <p class="mb-0">Commandes du jour - Club Agro</p>
                </div>
                <div>
                    <button class="btn btn-admin me-2" id="refreshBtn">
                        Actualiser
                    </button>
                    <button class="btn btn-danger-admin" id="logoutBtn">
                        Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Statut de connexion -->
        <div id="statusIndicator" class="status-indicator status-warning">
            Connexion à l'API en cours...
        </div>

        <!-- Statistiques rapides -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalCommandes">-</div>
                    <div class="stats-label">Commandes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalSandwichs">-</div>
                    <div class="stats-label">Sandwichs</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="sandwichPopulaire">-</div>
                    <div class="stats-label">Plus populaire</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="derniereActualisation">-</div>
                    <div class="stats-label">Dernière MAJ</div>
                </div>
            </div>
        </div>

        <!-- Tableau des commandes par prénom -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0" style="color: var(--agro-dark-green);">Commandes par client</h3>
                <span class="last-update">
                    Actualisation automatique toutes les 60 secondes
                </span>
            </div>

            <div class="table-container">
                <table class="table table-hover" id="tableauCommandes">
                    <thead>
                        <tr>
                            <th>Prénom</th>
                            <th>Sandwichs commandés</th>
                            <th>Commentaires</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="empty-state">
                                Chargement des commandes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Résumé par type de sandwich -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">Résumé de production</h3>
            
            <div class="table-container">
                <table class="table table-hover" id="resumeCommandes">
                    <thead>
                        <tr>
                            <th>Type de sandwich</th>
                            <th>Quantité totale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2" class="empty-state">
                                Chargement du résumé...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instructions pour les préparateurs -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">Instructions de préparation</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Berger Apicole (3,50€)</h5>
                    <p><strong>Ingrédients:</strong> Chèvre • Miel • Roquette • Noix • Pomme</p>
                </div>
                <div class="col-md-6">
                    <h5>Club (3,00€)</h5>
                    <p><strong>Ingrédients:</strong> Jambon • Mayo • Salade</p>
                </div>
                <div class="col-md-6">
                    <h5>Meat Free (3,00€)</h5>
                    <p><strong>Ingrédients:</strong> Légumes grillés • Houmous • Avocat</p>
                </div>
                <div class="col-md-6">
                    <h5>Italien (3,00€)</h5>
                    <p><strong>Ingrédients:</strong> Jambon de Parme • Pesto • Roquette • Mozza • Tomate séchée</p>
                </div>
                <div class="col-md-6">
                    <h5>Norvégien (3,00€)</h5>
                    <p><strong>Ingrédients:</strong> Saumon • Philadelphia • Salade</p>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <strong>Important:</strong> Les prix affichés sont pour les étudiants. Tarif non-étudiant : 4€ pour tous les sandwichs.
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
    </script>
    
    <script>
// Configuration API
const API_URL = "https://script.google.com/macros/s/AKfycby9TimFWReFLq4xScofyvhDk2zNouQcsCBZF7vjyfKNLCtGF3dVhZ3_LV52Qb8LYa7ibg/exec";

// Variables globales
let currentToken = null;
let autoRefreshInterval = null;
let isRequesting = false;

// Fonction principale pour faire des requêtes (simplifiée)
async function makeRequest(action, data = {}) {
    const params = new URLSearchParams({
        action: action,
        token: currentToken,
        ...data,
        _t: Date.now() // Cache buster
    });
    
    const url = `${API_URL}?${params.toString()}`;
    console.log('Requête:', action);

    try {
        const response = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit'
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('Réponse reçue pour', action, ':', result.success ? 'SUCCESS' : 'ERROR');
        
        return result;
    } catch (error) {
        console.error('Erreur requête', action, ':', error);
        throw error;
    }
}

// Fonction pour mettre à jour le statut de connexion
function mettreAJourStatut(message, type) {
    const statusDiv = document.getElementById('statusIndicator');
    if (statusDiv) {
        statusDiv.textContent = message;
        statusDiv.className = `status-indicator status-${type}`;
    }
}

// Fonction pour vérifier si le token est valide
async function verifierToken() {
    try {
        const result = await makeRequest('verifierToken');
        return result.success && result.valide;
    } catch (error) {
        console.error('Erreur vérification token:', error);
        return false;
    }
}

// Fonction pour récupérer les commandes
async function getCommandes() {
    try {
        if (isRequesting) {
            console.log('Requête déjà en cours, ignore...');
            return {};
        }
        
        isRequesting = true;
        mettreAJourStatut('Récupération des données...', 'warning');
        
        const result = await makeRequest('getCommandes');
        
        if (result.success) {
            mettreAJourStatut('Données récupérées avec succès', 'success');
            return result.data || {};
        } else {
            if (result.message && result.message.includes('Token invalide')) {
                console.log('Token invalide, redirection...');
                redirectToLogin();
                return {};
            }
            throw new Error(result.message || 'Erreur lors de la récupération des commandes');
        }
    } catch (error) {
        console.error('Erreur récupération commandes:', error);
        mettreAJourStatut('Erreur de connexion à l\'API', 'error');
        
        // Si erreur d'authentification, rediriger
        if (error.message && (error.message.includes('Token') || 
            error.message.includes('401') || error.message.includes('403'))) {
            redirectToLogin();
            return {};
        }
        
        afficherNotification('Erreur lors de la récupération des commandes: ' + error.message, 'error');
        return {};
    } finally {
        isRequesting = false;
    }
}

// Fonction pour rediriger vers la page de connexion
function redirectToLogin() {
    console.log('Redirection vers login...');
    sessionStorage.removeItem('adminToken');
    sessionStorage.removeItem('adminTokenTime');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
    
    window.location.href = 'login.html';
}

// Fonction pour remplir les tableaux avec les données
function remplirTableaux(data) {
    try {
        remplirTableauCommandes(data);
        remplirTableauResume(data);
        mettreAJourStatistiques(data);
        mettreAJourDerniereActualisation();
    } catch (error) {
        console.error('Erreur lors du remplissage des tableaux:', error);
        afficherNotification('Erreur lors de l\'affichage des données', 'error');
    }
}

// Fonction pour remplir le tableau des commandes par prénom
function remplirTableauCommandes(data) {
    const tbody = document.querySelector('#tableauCommandes tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const prenoms = Object.keys(data).sort();
    
    for (let prenom of prenoms) {
        const tr = document.createElement('tr');

        // Colonne prénom
        const tdPrenom = document.createElement('td');
        tdPrenom.textContent = prenom;
        tdPrenom.style.fontWeight = 'bold';
        tr.appendChild(tdPrenom);

        // Colonne sandwichs
        const tdSandwichs = document.createElement('td');
        const sandwichs = data[prenom].sandwichs || {};
        const sandwichsText = Object.entries(sandwichs)
            .filter(([type, nb]) => nb > 0)
            .map(([type, nb]) => `${type} (${nb})`)
            .join(", ");
        tdSandwichs.textContent = sandwichsText || 'Aucun sandwich';
        tr.appendChild(tdSandwichs);

        // Colonne commentaires
        const tdCommentaire = document.createElement('td');
        const commentaires = (data[prenom].commentaire || [])
            .filter(comm => comm && comm.trim() !== "")
            .join(" | ");
        tdCommentaire.textContent = commentaires || '-';
        tr.appendChild(tdCommentaire);

        tbody.appendChild(tr);
    }

    // Afficher un message si aucune commande
    if (prenoms.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'Aucune commande pour aujourd\'hui';
        td.className = 'empty-state';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
}

// Fonction pour remplir le tableau de résumé
function remplirTableauResume(data) {
    const resumeBody = document.querySelector('#resumeCommandes tbody');
    if (!resumeBody) return;
    
    resumeBody.innerHTML = '';
    const totaux = {};

    // Calculer les totaux par type de sandwich
    for (let prenom in data) {
        const sandwichs = data[prenom].sandwichs || {};
        for (let type in sandwichs) {
            const nb = Number(sandwichs[type]) || 0;
            totaux[type] = (totaux[type] || 0) + nb;
        }
    }

    // Types de sandwichs avec noms d'affichage
    const typesSandwichs = {
        'berger': 'Berger Apicole',
        'club': 'Club',
        'meat_free': 'Meat Free',
        'italien': 'Italien',
        'norvegien': 'Norvégien'
    };

    // Afficher tous les types
    Object.entries(typesSandwichs).forEach(([type, nom]) => {
        const tr = document.createElement('tr');
        
        const tdType = document.createElement('td');
        tdType.textContent = nom;
        tr.appendChild(tdType);

        const tdTotal = document.createElement('td');
        const total = totaux[type] || 0;
        tdTotal.textContent = total;
        tdTotal.style.fontWeight = 'bold';
        
        if (total > 0) {
            tdTotal.style.color = '#28a745';
        }
        
        tr.appendChild(tdTotal);
        resumeBody.appendChild(tr);
    });
}

// Fonction pour mettre à jour les statistiques
function mettreAJourStatistiques(data) {
    const totalCommandes = Object.keys(data).length;
    let totalSandwichs = 0;
    const totauxParType = {};

    // Calculer les totaux
    for (let prenom in data) {
        const sandwichs = data[prenom].sandwichs || {};
        for (let type in sandwichs) {
            const nb = Number(sandwichs[type]) || 0;
            totalSandwichs += nb;
            totauxParType[type] = (totauxParType[type] || 0) + nb;
        }
    }

    // Trouver le sandwich le plus populaire
    let sandwichPopulaire = '-';
    let maxQuantite = 0;
    const nomsAffichage = {
        'berger': 'Berger',
        'club': 'Club',
        'meat_free': 'Meat Free',
        'italien': 'Italien',
        'norvegien': 'Norvégien'
    };

    for (let type in totauxParType) {
        if (totauxParType[type] > maxQuantite) {
            maxQuantite = totauxParType[type];
            sandwichPopulaire = nomsAffichage[type] || type;
        }
    }

    // Mettre à jour l'affichage
    const elemTotalCommandes = document.getElementById('totalCommandes');
    const elemTotalSandwichs = document.getElementById('totalSandwichs');
    const elemSandwichPopulaire = document.getElementById('sandwichPopulaire');
    
    if (elemTotalCommandes) elemTotalCommandes.textContent = totalCommandes;
    if (elemTotalSandwichs) elemTotalSandwichs.textContent = totalSandwichs;
    if (elemSandwichPopulaire) elemSandwichPopulaire.textContent = sandwichPopulaire;
}

// Fonction pour mettre à jour l'heure de dernière actualisation
function mettreAJourDerniereActualisation() {
    const spanActualisation = document.getElementById('derniereActualisation');
    if (spanActualisation) {
        const maintenant = new Date();
        spanActualisation.textContent = maintenant.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
}

// Fonction pour actualiser les données
async function actualiserDonnees() {
    console.log('Actualisation des données...');
    
    const btnActualiser = document.getElementById('refreshBtn');
    if (btnActualiser) {
        btnActualiser.disabled = true;
        btnActualiser.textContent = 'Actualisation...';
    }
    
    try {
        const data = await getCommandes();
        remplirTableaux(data);
        afficherNotification('Données actualisées', 'success');
    } catch (error) {
        console.error('Erreur actualisation:', error);
        afficherNotification('Erreur lors de l\'actualisation', 'error');
    } finally {
        if (btnActualiser) {
            btnActualiser.disabled = false;
            btnActualiser.textContent = 'Actualiser';
        }
    }
}

// Fonction de déconnexion
async function deconnexion() {
    console.log('Déconnexion...');
    
    try {
        // Tenter d'invalider le token côté serveur
        await makeRequest('invaliderToken');
    } catch (error) {
        console.error('Erreur lors de l\'invalidation du token:', error);
        // On continue quand même la déconnexion
    }

    redirectToLogin();
}

// Fonction pour afficher les notifications
function afficherNotification(message, type) {
    const notification = document.getElementById('notification');
    if (notification) {
        const alertClass = type === 'success' ? 'success' : 
                         type === 'warning' ? 'warning' : 'danger';
        
        notification.innerHTML = `
            <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-masquer après 5 secondes pour les succès
        if (type === 'success') {
            setTimeout(() => {
                const alert = notification.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Dashboard chargé');
    
    // Récupérer le token
    currentToken = sessionStorage.getItem('adminToken');
    
    if (!currentToken) {
        console.log('Pas de token, redirection...');
        redirectToLogin();
        return;
    }

    // Vérifier si le token est encore valide
    console.log('Vérification du token...');
    try {
        const tokenValide = await verifierToken();
        
        if (!tokenValide) {
            console.log('Token invalide, redirection...');
            redirectToLogin();
            return;
        }
        
        console.log('Token valide, chargement des données...');
    } catch (error) {
        console.error('Erreur vérification token:', error);
        mettreAJourStatut('Erreur de connexion, reconnexion...', 'error');
        setTimeout(() => redirectToLogin(), 2000);
        return;
    }

    // Charger les données initiales
    await actualiserDonnees();

    // Configurer les gestionnaires d'événements
    const btnDeconnexion = document.getElementById('logoutBtn');
    if (btnDeconnexion) {
        btnDeconnexion.addEventListener('click', deconnexion);
    }

    const btnActualiser = document.getElementById('refreshBtn');
    if (btnActualiser) {
        btnActualiser.addEventListener('click', actualiserDonnees);
    }

    // Actualisation automatique toutes les 60 secondes
    autoRefreshInterval = setInterval(async () => {
        console.log('Actualisation automatique...');
        try {
            await actualiserDonnees();
        } catch (error) {
            console.error('Erreur actualisation auto:', error);
        }
    }, 60000);

    console.log('Dashboard initialisé avec succès');
});
    </script>
</body>

</html>