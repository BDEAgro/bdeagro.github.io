<!DOCTYPE html>
<html lang="fr" class="h-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard administrateur - Club Agro BDE">
    <title>Dashboard Admin - Club Agro | BDE Agro - UCLouvain</title>
    <link rel="shortcut icon" href="../assets/img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../apple-touch-icon.png" sizes="180x180">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        :root {
            --agro-green: #A8C302;
            --agro-dark-green: #2e7d32;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid var(--agro-green);
        }

        .table-container {
            overflow-x: auto;
        }

        .table th {
            background-color: var(--agro-green);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table td {
            border-color: #e9ecef;
            vertical-align: middle;
        }

        .btn-admin {
            background: linear-gradient(135deg, var(--agro-green), var(--agro-dark-green));
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(168, 195, 2, 0.4);
            color: white;
        }

        .btn-danger-admin {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-danger-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            color: white;
        }

        .stats-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--agro-dark-green);
        }

        .stats-label {
            color: #6c757d;
            font-weight: 500;
        }

        .last-update {
            font-size: 0.875rem;
            color: #6c757d;
            font-style: italic;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 2rem;
        }

        .cors-warning {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-light">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">Dashboard Administrateur</h1>
                    <p class="mb-0">Commandes du jour - Club Agro</p>
                </div>
                <div>
                    <button class="btn btn-admin me-2" id="refreshBtn">
                        üîÑ Actualiser
                    </button>
                    <button class="btn btn-danger-admin" id="logoutBtn">
                        üö™ D√©connexion
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Alerte CORS -->
        <div class="cors-warning" id="corsWarning">
            <h5>üîß Mode JSONP activ√©</h5>
            <p class="mb-2">Le dashboard utilise JSONP pour contourner les restrictions CORS de Google Apps Script.</p>
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-success btn-sm" onclick="actualiserDonnees()">üîÑ Tester la connexion</button>
                <button class="btn btn-info btn-sm" onclick="this.parentElement.parentElement.classList.add('d-none')">‚úÖ Compris</button>
            </div>
            <small class="text-muted d-block mt-2">
                Si les donn√©es ne se chargent toujours pas, v√©rifiez que votre Google Apps Script est bien d√©ploy√©.
            </small>
        </div>

        <!-- Statistiques rapides -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalCommandes">-</div>
                    <div class="stats-label">Commandes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="totalSandwichs">-</div>
                    <div class="stats-label">Sandwichs</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="sandwichPopulaire">-</div>
                    <div class="stats-label">Plus populaire</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-number" id="derniereActualisation">-</div>
                    <div class="stats-label">Derni√®re MAJ</div>
                </div>
            </div>
        </div>

        <!-- Tableau des commandes par pr√©nom -->
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0" style="color: var(--agro-dark-green);">Commandes par client</h3>
                <span class="last-update">
                    Actualisation automatique toutes les 45 secondes
                </span>
            </div>

            <div class="table-container">
                <table class="table table-hover" id="tableauCommandes">
                    <thead>
                        <tr>
                            <th>Pr√©nom</th>
                            <th>Sandwichs command√©s</th>
                            <th>Commentaires</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="empty-state">
                                Chargement des commandes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- R√©sum√© par type de sandwich -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">R√©sum√© de production</h3>
            
            <div class="table-container">
                <table class="table table-hover" id="resumeCommandes">
                    <thead>
                        <tr>
                            <th>Type de sandwich</th>
                            <th>Quantit√© totale</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2" class="empty-state">
                                Chargement du r√©sum√©...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Instructions pour les pr√©parateurs -->
        <div class="dashboard-card">
            <h3 class="mb-3" style="color: var(--agro-dark-green);">Instructions de pr√©paration</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Berger Apicole (3,50‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Ch√®vre ‚Ä¢ Miel ‚Ä¢ Roquette ‚Ä¢ Noix ‚Ä¢ Pomme</p>
                </div>
                <div class="col-md-6">
                    <h5>Club (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Jambon ‚Ä¢ Mayo ‚Ä¢ Salade</p>
                </div>
                <div class="col-md-6">
                    <h5>Meat Free (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> L√©gumes grill√©s ‚Ä¢ Houmous ‚Ä¢ Avocat</p>
                </div>
                <div class="col-md-6">
                    <h5>Italien (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Jambon de Parme ‚Ä¢ Pesto ‚Ä¢ Roquette ‚Ä¢ Mozza ‚Ä¢ Tomate s√©ch√©e</p>
                </div>
                <div class="col-md-6">
                    <h5>Norv√©gien (3,00‚Ç¨)</h5>
                    <p><strong>Ingr√©dients:</strong> Saumon ‚Ä¢ Philadelphia ‚Ä¢ Salade</p>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <strong>Important:</strong> Les prix affich√©s sont pour les √©tudiants. Tarif non-√©tudiant : 4‚Ç¨ pour tous les sandwichs.
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
    </script>
    
    <script>
// Configuration API
const API_URL = "https://script.google.com/macros/s/AKfycbwSDp_vaj1ZjATBibQHi-50OL380L_Rcz7sEFhyzbiuLUygq_TJm-zADHhvpoPFtPWRuQ/exec";

// Variables globales
let currentToken = null;
let autoRefreshInterval = null;
let isRequesting = false; // Pour √©viter les requ√™tes multiples

// Fonction pour faire des requ√™tes POST JSON
async function makeJsonRequest(action, data = {}) {
    const payload = {
        action: action,
        token: currentToken,
        ...data
    };

    console.log('Envoi requ√™te:', action);

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        console.log('R√©ponse re√ßue pour', action, ':', result.success ? 'SUCCESS' : 'ERROR');
        
        return result;
    } catch (error) {
        console.error('Erreur requ√™te', action, ':', error);
        throw error;
    }
}

// Fonction pour v√©rifier si le token est valide
async function verifierToken() {
    try {
        const result = await makeJsonRequest('verifierToken');
        return result.success && result.valide;
    } catch (error) {
        console.error('Erreur v√©rification token:', error);
        return false;
    }
}

// Fonction pour r√©cup√©rer les commandes
async function getCommandes() {
    try {
        if (isRequesting) {
            console.log('Requ√™te d√©j√† en cours, ignore...');
            return {};
        }
        
        isRequesting = true;
        const result = await makeJsonRequest('getCommandes');
        
        if (result.success) {
            return result.data || {};
        } else {
            if (result.message && result.message.includes('Token invalide')) {
                console.log('Token invalide, redirection...');
                redirectToLogin();
                return {};
            }
            throw new Error(result.message || 'Erreur lors de la r√©cup√©ration des commandes');
        }
    } catch (error) {
        console.error('Erreur r√©cup√©ration commandes:', error);
        
        // Si erreur d'authentification, rediriger
        if (error.message && (error.message.includes('Token') || 
            error.message.includes('401') || error.message.includes('403'))) {
            redirectToLogin();
            return {};
        }
        
        afficherNotification('Erreur lors de la r√©cup√©ration des commandes: ' + error.message, 'error');
        return {};
    } finally {
        isRequesting = false;
    }
}

// Fonction pour rediriger vers la page de connexion
function redirectToLogin() {
    console.log('Redirection vers login...');
    sessionStorage.removeItem('adminToken');
    sessionStorage.removeItem('adminTokenTime');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    window.location.href = 'login.html';
}

// Fonction pour remplir les tableaux avec les donn√©es
function remplirTableaux(data) {
    try {
        remplirTableauCommandes(data);
        remplirTableauResume(data);
        mettreAJourStatistiques(data);
        mettreAJourDerniereActualisation();
    } catch (error) {
        console.error('Erreur lors du remplissage des tableaux:', error);
        afficherNotification('Erreur lors de l\'affichage des donn√©es', 'error');
    }
}

// Fonction pour remplir le tableau des commandes par pr√©nom
function remplirTableauCommandes(data) {
    const tbody = document.querySelector('#tableauCommandes tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const prenoms = Object.keys(data).sort();
    
    for (let prenom of prenoms) {
        const tr = document.createElement('tr');

        // Colonne pr√©nom
        const tdPrenom = document.createElement('td');
        tdPrenom.textContent = prenom;
        tdPrenom.style.fontWeight = 'bold';
        tr.appendChild(tdPrenom);

        // Colonne sandwichs
        const tdSandwichs = document.createElement('td');
        const sandwichs = data[prenom].sandwichs || {};
        const sandwichsText = Object.entries(sandwichs)
            .filter(([type, nb]) => nb > 0)
            .map(([type, nb]) => `${type} (${nb})`)
            .join(", ");
        tdSandwichs.textContent = sandwichsText || 'Aucun sandwich';
        tr.appendChild(tdSandwichs);

        // Colonne commentaires
        const tdCommentaire = document.createElement('td');
        const commentaires = (data[prenom].commentaire || [])
            .filter(comm => comm && comm.trim() !== "")
            .join(" | ");
        tdCommentaire.textContent = commentaires || '-';
        tr.appendChild(tdCommentaire);

        tbody.appendChild(tr);
    }

    // Afficher un message si aucune commande
    if (prenoms.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = 'Aucune commande pour aujourd\'hui';
        td.style.textAlign = 'center';
        td.style.fontStyle = 'italic';
        tr.appendChild(td);
        tbody.appendChild(tr);
    }
}

// Fonction pour remplir le tableau de r√©sum√©
function remplirTableauResume(data) {
    const resumeBody = document.querySelector('#resumeCommandes tbody');
    if (!resumeBody) return;
    
    resumeBody.innerHTML = '';
    const totaux = {};

    // Calculer les totaux par type de sandwich
    for (let prenom in data) {
        const sandwichs = data[prenom].sandwichs || {};
        for (let type in sandwichs) {
            const nb = Number(sandwichs[type]) || 0;
            totaux[type] = (totaux[type] || 0) + nb;
        }
    }

    // Types de sandwichs avec noms d'affichage
    const typesSandwichs = {
        'berger': 'Berger Apicole',
        'club': 'Club',
        'meat_free': 'Meat Free',
        'italien': 'Italien',
        'norvegien': 'Norv√©gien'
    };

    // Afficher tous les types
    Object.entries(typesSandwichs).forEach(([type, nom]) => {
        const tr = document.createElement('tr');
        
        const tdType = document.createElement('td');
        tdType.textContent = nom;
        tr.appendChild(tdType);

        const tdTotal = document.createElement('td');
        const total = totaux[type] || 0;
        tdTotal.textContent = total;
        tdTotal.style.fontWeight = 'bold';
        
        if (total > 0) {
            tdTotal.style.color = '#28a745';
        }
        
        tr.appendChild(tdTotal);
        resumeBody.appendChild(tr);
    });
}

// Fonction pour mettre √† jour les statistiques
function mettreAJourStatistiques(data) {
    const totalCommandes = Object.keys(data).length;
    let totalSandwichs = 0;
    const totauxParType = {};

    // Calculer les totaux
    for (let prenom in data) {
        const sandwichs = data[prenom].sandwichs || {};
        for (let type in sandwichs) {
            const nb = Number(sandwichs[type]) || 0;
            totalSandwichs += nb;
            totauxParType[type] = (totauxParType[type] || 0) + nb;
        }
    }

    // Trouver le sandwich le plus populaire
    let sandwichPopulaire = '-';
    let maxQuantite = 0;
    const nomsAffichage = {
        'berger': 'Berger',
        'club': 'Club',
        'meat_free': 'Meat Free',
        'italien': 'Italien',
        'norvegien': 'Norv√©gien'
    };

    for (let type in totauxParType) {
        if (totauxParType[type] > maxQuantite) {
            maxQuantite = totauxParType[type];
            sandwichPopulaire = nomsAffichage[type] || type;
        }
    }

    // Mettre √† jour l'affichage
    const elemTotalCommandes = document.getElementById('totalCommandes');
    const elemTotalSandwichs = document.getElementById('totalSandwichs');
    const elemSandwichPopulaire = document.getElementById('sandwichPopulaire');
    
    if (elemTotalCommandes) elemTotalCommandes.textContent = totalCommandes;
    if (elemTotalSandwichs) elemTotalSandwichs.textContent = totalSandwichs;
    if (elemSandwichPopulaire) elemSandwichPopulaire.textContent = sandwichPopulaire;
}

// Fonction pour mettre √† jour l'heure de derni√®re actualisation
function mettreAJourDerniereActualisation() {
    const spanActualisation = document.getElementById('derniereActualisation');
    if (spanActualisation) {
        const maintenant = new Date();
        spanActualisation.textContent = maintenant.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
}

// Fonction pour actualiser les donn√©es
async function actualiserDonnees() {
    console.log('Actualisation des donn√©es...');
    
    const btnActualiser = document.getElementById('refreshBtn');
    if (btnActualiser) {
        btnActualiser.disabled = true;
        btnActualiser.textContent = 'Actualisation...';
    }
    
    try {
        const data = await getCommandes();
        remplirTableaux(data);
        afficherNotification('Donn√©es actualis√©es avec succ√®s', 'success');
    } catch (error) {
        console.error('Erreur actualisation:', error);
    } finally {
        if (btnActualiser) {
            btnActualiser.disabled = false;
            btnActualiser.textContent = 'Actualiser';
        }
    }
}

// Fonction de d√©connexion
async function deconnexion() {
    console.log('D√©connexion...');
    
    try {
        // Tenter d'invalider le token c√¥t√© serveur
        await makeJsonRequest('invaliderToken');
    } catch (error) {
        console.error('Erreur lors de l\'invalidation du token:', error);
        // On continue quand m√™me la d√©connexion
    }

    // Nettoyer c√¥t√© client
    sessionStorage.removeItem('adminToken');
    sessionStorage.removeItem('adminTokenTime');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Rediriger vers la page de connexion
    window.location.href = 'login.html';
}

// Fonction pour afficher les notifications
function afficherNotification(message, type) {
    const notification = document.getElementById('notification');
    if (notification) {
        const alertClass = type === 'success' ? 'success' : 
                         type === 'warning' ? 'warning' : 'danger';
        
        notification.innerHTML = `
            <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Auto-masquer apr√®s 5 secondes
        setTimeout(() => {
            const alert = notification.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
}

// Initialisation
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Dashboard charg√©');
    
    // R√©cup√©rer le token
    currentToken = sessionStorage.getItem('adminToken');
    
    if (!currentToken) {
        console.log('Pas de token, redirection...');
        redirectToLogin();
        return;
    }

    // V√©rifier si le token est encore valide
    try {
        const tokenValide = await verifierToken();
        
        if (!tokenValide) {
            console.log('Token invalide, redirection...');
            redirectToLogin();
            return;
        }
        
        console.log('Token valide, chargement des donn√©es...');
    } catch (error) {
        console.error('Erreur v√©rification token:', error);
        redirectToLogin();
        return;
    }

    // Charger les donn√©es initiales
    await actualiserDonnees();

    // Configurer les gestionnaires d'√©v√©nements
    const btnDeconnexion = document.getElementById('logoutBtn');
    if (btnDeconnexion) {
        btnDeconnexion.addEventListener('click', deconnexion);
    }

    const btnActualiser = document.getElementById('refreshBtn');
    if (btnActualiser) {
        btnActualiser.addEventListener('click', actualiserDonnees);
    }

    // Actualisation automatique toutes les 60 secondes
    autoRefreshInterval = setInterval(async () => {
        console.log('Actualisation automatique...');
        await actualiserDonnees();
    }, 60000);

    console.log('Dashboard initialis√© avec succ√®s');
});
    </script>
</body>

</html>